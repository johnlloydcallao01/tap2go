(()=>{var e={};e.id=5347,e.ids=[5347],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},42302:(e,t,s)=>{"use strict";s.d(t,{O:()=>c});var r=s(37449);let n={},a={order_status:["where is my order","order status","track my order","delivery time","when will my food arrive","order tracking"],payment:["payment failed","refund","billing","charge","payment method","credit card","paypal"],delivery:["delivery fee","delivery time","delivery area","contactless delivery","driver location","delivery address"],restaurant:["restaurant hours","menu","restaurant location","cuisine type","restaurant rating","food quality"],account:["login","password","account settings","profile","email change","phone number"],technical:["app not working","website down","bug","error","crash","loading issue"],general:["how does it work","what is tap2go","getting started","help","support","contact"]},o=process.env.GOOGLE_AI_API_KEY;if(!o)throw Error("GOOGLE_AI_API_KEY is not set");let i=new r.ij(o);class u{constructor(){this.chatSessions=new Map,this.model=i.getGenerativeModel({model:"gemini-1.5-flash",generationConfig:{temperature:.7,maxOutputTokens:1024,topP:.8,topK:40}})}createChatSession(e){let t=this.generateSessionId(),s={id:t,userId:e,messages:[],context:{lastActivity:new Date},status:"active",createdAt:new Date};return this.chatSessions.set(t,s),s}getChatSession(e){return this.chatSessions.get(e)||null}async sendMessage(e,t,s){let r=this.getChatSession(e);if(!r)throw Error("Chat session not found");s&&(r.context={...r.context,...s}),r.context.lastActivity=new Date;let n={id:this.generateMessageId(),role:"user",content:t,timestamp:new Date};r.messages.push(n);let a=this.detectIntent(t),o=await this.generateAIResponse(r,t,a),i={id:this.generateMessageId(),role:"assistant",content:o.content,timestamp:new Date,quickReplies:o.quickReplies,metadata:{intent:a,confidence:o.confidence,escalated:o.escalated}};return r.messages.push(i),o.escalated&&(r.status="escalated"),i}detectIntent(e){let t=e.toLowerCase();for(let[e,s]of Object.entries(a))if(Array.isArray(s)&&s.some(e=>t.includes(e)))return e;return"general"}async generateAIResponse(e,t,s){try{let r=e.messages.slice(-6).map(e=>`${e.role}: ${e.content}`).join("\n"),n=this.buildPrompt(t,s,r,e.context),a=await this.model.generateContent(n),o=(await a.response).text(),i=this.getQuickReplies(s),u=this.shouldEscalate(t,o);return{content:o.trim(),quickReplies:i,confidence:.8,escalated:u}}catch(e){return console.error("Error generating AI response:",e),{content:"I apologize, but I'm having trouble processing your request right now. Let me connect you with our human support team who can assist you better.",quickReplies:["Contact Support","Try Again"],confidence:.1,escalated:!0}}}buildPrompt(e,t,s,r){let a=[r.userName?`Customer name: ${r.userName}`:"",r.location?`Customer location: ${r.location}`:"",r.currentOrder?`Current order: ${r.currentOrder}`:""].filter(Boolean).join("\n");return`
${n}

## CONVERSATION CONTEXT
${a}

## CONVERSATION HISTORY
${s}

## CURRENT USER MESSAGE
User: ${e}

## DETECTED INTENT
${t}

## INSTRUCTIONS
1. Respond as Tap2Go's AI assistant based on the knowledge base above
2. Be helpful, friendly, and professional
3. Keep responses concise but informative (2-3 sentences max unless detailed info is needed)
4. Use Filipino-friendly English
5. If you need to escalate, clearly state you'll connect them with human support
6. Provide specific, actionable information when possible
7. If asking for order details, be specific about what information you need

Respond naturally and helpfully:
    `.trim()}getQuickReplies(e){return[]}shouldEscalate(e,t){let s=e.toLowerCase(),r=t.toLowerCase();return!!(s.includes("human")||s.includes("person")||s.includes("representative")||s.includes("manager")||["refund","complaint","angry","frustrated","legal","lawsuit","food poisoning","sick","harassment","fraud","security","manager","supervisor","human","person","representative"].some(e=>s.includes(e))||r.includes("i don't know")||r.includes("i'm not sure")||r.includes("contact support"))}generateSessionId(){return`chat_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}generateMessageId(){return`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}getWelcomeMessage(){return{id:this.generateMessageId(),role:"assistant",content:"Hi! I'm Tap2Go's AI assistant. I can help you track orders, find restaurants, answer questions about delivery, and more. How can I help you today?",timestamp:new Date,quickReplies:[]}}cleanupOldSessions(e=24){let t=new Date(Date.now()-60*e*6e4);for(let[e,s]of this.chatSessions.entries())s.context.lastActivity<t&&this.chatSessions.delete(e)}}let c=new u},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},70129:(e,t,s)=>{"use strict";s.r(t),s.d(t,{patchFetch:()=>m,routeModule:()=>d,serverHooks:()=>h,workAsyncStorage:()=>p,workUnitAsyncStorage:()=>g});var r={};s.r(r),s.d(r,{GET:()=>l,POST:()=>c});var n=s(96559),a=s(48088),o=s(37719),i=s(32190),u=s(42302);async function c(e){try{if("true"!==process.env.ENABLE_AI_FEATURES)return i.NextResponse.json({error:"Chatbot service is not available"},{status:503});let{sessionId:t,message:s,context:r}=await e.json();if(!t||"string"!=typeof t)return i.NextResponse.json({error:"Session ID is required and must be a string"},{status:400});if(!s||"string"!=typeof s)return i.NextResponse.json({error:"Message is required and must be a string"},{status:400});if(s.length>1e3)return i.NextResponse.json({error:"Message is too long (max 1,000 characters)"},{status:400});let n=u.O.getChatSession(t);if(!n)return i.NextResponse.json({error:"Chat session not found. Please start a new conversation."},{status:404});if("ended"===n.status)return i.NextResponse.json({error:"Chat session has ended. Please start a new conversation."},{status:400});let a=await u.O.sendMessage(t,s,r),o=u.O.getChatSession(t);return i.NextResponse.json({success:!0,response:a,sessionStatus:o?.status,timestamp:new Date().toISOString()})}catch(e){return console.error("Error processing chat message:",e),i.NextResponse.json({error:"Failed to process message",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}async function l(){return i.NextResponse.json({error:"Method not allowed. Use POST to send messages."},{status:405})}let d=new n.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/chatbot/message/route",pathname:"/api/chatbot/message",filename:"route",bundlePath:"app/api/chatbot/message/route"},resolvedPagePath:"C:\\Users\\ACER\\Desktop\\tap2go\\apps\\web\\src\\app\\api\\chatbot\\message\\route.ts",nextConfigOutput:"",userland:r}),{workAsyncStorage:p,workUnitAsyncStorage:g,serverHooks:h}=d;function m(){return(0,o.patchFetch)({workAsyncStorage:p,workUnitAsyncStorage:g})}},78335:()=>{},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[4447,580,7449],()=>s(70129));module.exports=r})();