(()=>{var e={};e.id=9994,e.ids=[9994],e.modules={1241:()=>{},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},28010:(e,t,r)=>{"use strict";r.d(t,{t:()=>a});var s=r(63511);class a{static getInstance(){return a.instance||(a.instance=new a),a.instance}async trackUsage(e,t){try{let r=s.E2||s.ND,{data:a,error:i}=await r.from("media_usage").insert({media_file_id:e,entity_type:t.entity_type,entity_id:t.entity_id,usage_type:t.usage_type,usage_context:t.context||{}}).select("*").single();if(i)throw Error(`Failed to track media usage: ${i.message}`);return a}catch(e){throw console.error("Error tracking media usage:",e),e}}async removeUsage(e,t,r){try{let a=s.E2||s.ND,{error:i}=await a.from("media_usage").delete().eq("media_file_id",e).eq("entity_type",t).eq("entity_id",r);if(i)throw Error(`Failed to remove media usage: ${i.message}`);return!0}catch(e){throw console.error("Error removing media usage:",e),e}}async getFileUsage(e){try{let t=s.E2||s.ND,{data:r,error:a}=await t.from("media_usage").select("*").eq("media_file_id",e).order("created_at",{ascending:!1});if(a)throw Error(`Failed to get file usage: ${a.message}`);return r||[]}catch(e){throw console.error("Error getting file usage:",e),e}}async getEntityMedia(e,t){try{let r=s.E2||s.ND,{data:a,error:i}=await r.from("media_usage").select(`
          *,
          media_file:media_files(*)
        `).eq("entity_type",e).eq("entity_id",t).order("created_at",{ascending:!1});if(i)throw Error(`Failed to get entity media: ${i.message}`);return a||[]}catch(e){throw console.error("Error getting entity media:",e),e}}async canDeleteFile(e){try{let t=await this.getFileUsage(e);return{canDelete:0===t.length,usageCount:t.length,usages:t}}catch(e){throw console.error("Error checking file deletion safety:",e),e}}async getUsageStats(){try{let e=s.E2||s.ND,{count:t}=await e.from("media_files").select("*",{count:"exact",head:!0}).eq("status","active"),{count:r}=await e.from("media_files").select("*",{count:"exact",head:!0}).eq("status","active").eq("is_used",!0),{count:a}=await e.from("media_usage").select("*",{count:"exact",head:!0}),{data:i}=await e.from("media_usage").select("entity_type").then(({data:e})=>{if(!e)return{data:[]};let t=e.reduce((e,t)=>(e[t.entity_type]=(e[t.entity_type]||0)+1,e),{});return{data:Object.entries(t).map(([e,t])=>({entity_type:e,count:t}))}});return{totalFiles:t||0,usedFiles:r||0,unusedFiles:(t||0)-(r||0),totalUsages:a||0,usagesByType:i||[]}}catch(e){throw console.error("Error getting usage stats:",e),e}}async updateEntityMedia(e,t,r){try{let a=s.E2||s.ND;if(await a.from("media_usage").delete().eq("entity_type",e).eq("entity_id",t),r.length>0){let s=r.map(r=>({media_file_id:r.mediaFileId,entity_type:e,entity_id:t,usage_type:r.usageType,usage_context:r.context||{}})),{error:i}=await a.from("media_usage").insert(s);if(i)throw Error(`Failed to update entity media: ${i.message}`)}}catch(e){throw console.error("Error updating entity media:",e),e}}async findUnusedFiles(e){try{let t=(s.E2||s.ND).from("media_files").select("id, filename, file_size, created_at, file_url").eq("status","active").eq("is_used",!1);if(e){let r=new Date;r.setDate(r.getDate()-e),t=t.lt("created_at",r.toISOString())}let{data:r,error:a}=await t.order("created_at",{ascending:!0});if(a)throw Error(`Failed to find unused files: ${a.message}`);return r||[]}catch(e){throw console.error("Error finding unused files:",e),e}}}},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},63511:(e,t,r)=>{"use strict";r.d(t,{E2:()=>u,ND:()=>o});var s=r(94202);let a="https://iblujnytqusttngujhob.supabase.co",i="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlibHVqbnl0cXVzdHRuZ3VqaG9iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkyNjQxNjMsImV4cCI6MjA2NDg0MDE2M30.zt4RCWmS3POQtULRl27UcdGGCPGbYPJvTr8l6YlOhvA",n=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!a||!i)throw Error("Missing Supabase environment variables. Please check your .env.local file.");let o=(0,s.createClient)(a,i,{auth:{persistSession:!1},db:{schema:"public"},realtime:{params:{eventsPerSecond:-1}},global:{headers:{"X-Client-Info":"tap2go-cms"}}}),u=n?(0,s.createClient)(a,n,{auth:{autoRefreshToken:!1,persistSession:!1},db:{schema:"public"},realtime:{params:{eventsPerSecond:-1}},global:{headers:{"X-Client-Info":"tap2go-cms-admin"}}}):null},63699:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>y,routeModule:()=>l,serverHooks:()=>m,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>p});var s={};r.r(s),r.d(s,{DELETE:()=>d,POST:()=>c});var a=r(96559),i=r(48088),n=r(37719),o=r(32190),u=r(28010);async function c(e){try{let{media_file_id:t,entity_type:r,entity_id:s,usage_type:a,context:i}=await e.json();if(!t||!r||!s||!a)return o.NextResponse.json({error:"media_file_id, entity_type, entity_id, and usage_type are required"},{status:400});let n=u.t.getInstance(),c=await n.trackUsage(t,{entity_type:r,entity_id:s,usage_type:a,context:i});return o.NextResponse.json({success:!0,message:"Media usage tracked successfully",data:c})}catch(t){console.error("Media usage tracking error:",t);let e=t instanceof Error?t.message:"Failed to track usage";return o.NextResponse.json({error:"Usage tracking failed",message:e},{status:500})}}async function d(e){try{let{searchParams:t}=new URL(e.url),r=t.get("media_file_id"),s=t.get("entity_type"),a=t.get("entity_id");if(!r||!s||!a)return o.NextResponse.json({error:"media_file_id, entity_type, and entity_id are required"},{status:400});let i=u.t.getInstance();if(!await i.removeUsage(parseInt(r),s,a))return o.NextResponse.json({error:"Failed to remove usage tracking"},{status:500});return o.NextResponse.json({success:!0,message:"Media usage removed successfully"})}catch(t){console.error("Media usage removal error:",t);let e=t instanceof Error?t.message:"Failed to remove usage";return o.NextResponse.json({error:"Usage removal failed",message:e},{status:500})}}let l=new a.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/media/usage/route",pathname:"/api/media/usage",filename:"route",bundlePath:"app/api/media/usage/route"},resolvedPagePath:"C:\\Users\\ACER\\Desktop\\tap2go\\apps\\web\\src\\app\\api\\media\\usage\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:g,workUnitAsyncStorage:p,serverHooks:m}=l;function y(){return(0,n.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:p})}},72088:()=>{},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},80765:e=>{function t(e){var t=Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=80765,e.exports=t},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[4447,580,4202],()=>r(63699));module.exports=s})();