(()=>{var e={};e.id=4711,e.ids=[4711],e.modules={1241:()=>{},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},22803:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>_,routeModule:()=>m,serverHooks:()=>y,workAsyncStorage:()=>b,workUnitAsyncStorage:()=>g});var i={};t.r(i),t.d(i,{POST:()=>h});var o=t(96559),s=t(48088),a=t(37719),n=t(32190),l=t(63511),u=t(55511),c=t.n(u);async function d(e){if(!l.E2)throw Error("Supabase admin client not available");if("/"===e||!e)return null;let{data:r}=await l.E2.from("media_folders").select("id").eq("path",e).single();if(r)return r.id;let t=e.split("/").pop()||"Untitled",i=t.toLowerCase().replace(/[^a-z0-9]+/g,"-"),{data:o,error:s}=await l.E2.from("media_folders").insert({name:t,slug:`${i}-${Date.now()}`,path:e,description:"Auto-created folder from Cloudinary upload",is_system:!1}).select("id").single();return s?(console.error("Error creating folder:",s),null):o?.id||null}async function p(e){if(!l.E2)throw Error("Supabase admin client not available");let{folderPath:r,filename:t}=function(e){let r=e.split("/");if(1===r.length)return{folderPath:"/",filename:r[0]};let t=r.pop()||"";return{folderPath:"/"+r.join("/"),filename:t}}(e.public_id),i=await d(r),o="video"===e.resource_type?"video":"raw"===e.resource_type?"document":"image",s="image"===e.resource_type?`image/${e.format}`:"video"===e.resource_type?`video/${e.format}`:`application/${e.format}`,a=null;e.width&&e.height&&(a=(e.width/e.height).toFixed(4));let n={filename:`${t}.${e.format}`,original_filename:e.original_filename||`${t}.${e.format}`,file_path:e.public_id,file_url:e.secure_url,thumbnail_url:"image"===e.resource_type?e.secure_url.replace("/upload/","/upload/c_thumb,w_300,h_300/"):null,file_type:o,mime_type:s,file_size:e.bytes,file_extension:e.format,width:e.width||null,height:e.height||null,aspect_ratio:a,folder_id:i,folder_path:r,cloudinary_public_id:e.public_id,cloudinary_version:e.version.toString(),storage_provider:"cloudinary",uploaded_by:"system",upload_source:"cloudinary_webhook",status:"active",visibility:"public"},{data:u,error:c}=await l.E2.from("media_files").upsert(n,{onConflict:"cloudinary_public_id",ignoreDuplicates:!1}).select("id").single();if(c)throw console.error("Error saving media file to database:",c),c;return console.log("Media file saved to database:",{id:u?.id,publicId:e.public_id,filename:n.filename}),u}async function f(e){if(!l.E2)throw Error("Supabase admin client not available");let{error:r}=await l.E2.from("media_files").update({status:"deleted",deleted_at:new Date().toISOString(),deleted_by:"system"}).eq("cloudinary_public_id",e.public_id);if(r)throw console.error("Error soft deleting media file:",r),r;console.log("Media file soft deleted:",{publicId:e.public_id})}async function h(e){try{let r=await e.text(),t=e.headers.get("x-cld-timestamp")||"",i=e.headers.get("x-cld-signature")||"";if(console.log("Cloudinary webhook received:",{timestamp:t,hasSignature:!!i,bodyLength:r.length}),!function(e,r,t){let i=process.env.CLOUDINARY_WEBHOOK_SECRET;if(!i)return console.warn("CLOUDINARY_WEBHOOK_SECRET not configured, skipping signature verification"),!0;try{let o=c().createHmac("sha256",i).update(e+r).digest("hex");return c().timingSafeEqual(Buffer.from(t,"hex"),Buffer.from(o,"hex"))}catch(e){return console.error("Error verifying Cloudinary signature:",e),!1}}(r,t,i))return console.error("Invalid Cloudinary webhook signature"),n.NextResponse.json({error:"Invalid signature"},{status:401});let o=JSON.parse(r);switch(console.log(`Processing Cloudinary webhook: ${o.notification_type}`,{publicId:o.public_id,resourceType:o.resource_type,bytes:o.bytes}),o.notification_type){case"upload":case"update":await p(o);break;case"delete":await f(o);break;default:console.log(`Unhandled Cloudinary notification type: ${o.notification_type}`)}return n.NextResponse.json({success:!0,message:"Webhook processed successfully",publicId:o.public_id,notificationType:o.notification_type})}catch(r){console.error("Cloudinary webhook error:",r);let e=r instanceof Error?r.message:"Unknown error";return n.NextResponse.json({error:"Webhook processing failed",message:e},{status:500})}}let m=new o.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/webhooks/cloudinary/route",pathname:"/api/webhooks/cloudinary",filename:"route",bundlePath:"app/api/webhooks/cloudinary/route"},resolvedPagePath:"C:\\Users\\ACER\\Desktop\\tap2go\\apps\\web\\src\\app\\api\\webhooks\\cloudinary\\route.ts",nextConfigOutput:"",userland:i}),{workAsyncStorage:b,workUnitAsyncStorage:g,serverHooks:y}=m;function _(){return(0,a.patchFetch)({workAsyncStorage:b,workUnitAsyncStorage:g})}},27910:e=>{"use strict";e.exports=require("stream")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},63511:(e,r,t)=>{"use strict";t.d(r,{E2:()=>l,ND:()=>n});var i=t(94202);let o="https://iblujnytqusttngujhob.supabase.co",s="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlibHVqbnl0cXVzdHRuZ3VqaG9iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkyNjQxNjMsImV4cCI6MjA2NDg0MDE2M30.zt4RCWmS3POQtULRl27UcdGGCPGbYPJvTr8l6YlOhvA",a=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!o||!s)throw Error("Missing Supabase environment variables. Please check your .env.local file.");let n=(0,i.createClient)(o,s,{auth:{persistSession:!1},db:{schema:"public"},realtime:{params:{eventsPerSecond:-1}},global:{headers:{"X-Client-Info":"tap2go-cms"}}}),l=a?(0,i.createClient)(o,a,{auth:{autoRefreshToken:!1,persistSession:!1},db:{schema:"public"},realtime:{params:{eventsPerSecond:-1}},global:{headers:{"X-Client-Info":"tap2go-cms-admin"}}}):null},72088:()=>{},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},80765:e=>{function r(e){var r=Error("Cannot find module '"+e+"'");throw r.code="MODULE_NOT_FOUND",r}r.keys=()=>[],r.resolve=r,r.id=80765,e.exports=r},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),i=r.X(0,[4447,580,4202],()=>t(22803));module.exports=i})();