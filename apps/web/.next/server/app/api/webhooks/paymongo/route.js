(()=>{var e={};e.id=8045,e.ids=[8045],e.modules={588:(e,t,r)=>{"use strict";r.a(e,async(e,a)=>{try{r.d(t,{G7:()=>c,Qk:()=>u,db:()=>p});var o=r(9801),n=r(7879),s=r(14276),i=e([o,n,s]);[o,n,s]=i.then?(await i)():i;let d=null,c=null,u=null;!function(){try{if((0,o.getApps)().length>0){d=(0,o.getApps)().find(e=>"admin"===e.name)||(0,o.getApps)()[0],c=(0,n.getFirestore)(d),u=(0,s.getAuth)(d);return}let e=process.env.FIREBASE_ADMIN_PROJECT_ID,t=process.env.FIREBASE_ADMIN_PRIVATE_KEY,r=process.env.FIREBASE_ADMIN_CLIENT_EMAIL;if(!e||!t||!r)return void console.warn("Firebase Admin environment variables not found. Admin features will be disabled.");let a=t;a=(a=a.replace(/^["']|["']$/g,"")).replace(/\\n/g,"\n");let i={type:"service_account",project_id:e,private_key:a,client_email:r};d=(0,o.initializeApp)({credential:(0,o.cert)(i),projectId:e},"admin"),c=(0,n.getFirestore)(d),u=(0,s.getAuth)(d),console.log("Firebase Admin initialized successfully")}catch(e){console.error("Failed to initialize Firebase Admin:",e),d=null,c=null,u=null}}();let p=c;a()}catch(e){a(e)}})},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},7879:e=>{"use strict";e.exports=import("firebase-admin/firestore")},9801:e=>{"use strict";e.exports=import("firebase-admin/app")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12412:e=>{"use strict";e.exports=require("assert")},14276:e=>{"use strict";e.exports=import("firebase-admin/auth")},21820:e=>{"use strict";e.exports=require("os")},26671:(e,t,r)=>{"use strict";r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{DELETE:()=>y,GET:()=>l,POST:()=>d,PUT:()=>m});var o=r(32190),n=r(38561),s=r(588),i=e([s]);async function d(e){try{let t=await e.text(),r=e.headers.get("paymongo-signature");if(!r)return console.error("Missing PayMongo signature header"),o.NextResponse.json({error:"Missing signature"},{status:400});let a=process.env.PAYMONGO_WEBHOOK_SECRET;if(a&&!n.w.verifyWebhookSignature(t,r,a))return console.error("Invalid PayMongo webhook signature"),o.NextResponse.json({error:"Invalid signature"},{status:401});let s=JSON.parse(t),i=s.data.attributes.type,d=s.data.attributes.data;switch(console.log(`Received PayMongo webhook: ${i}`,{eventId:s.data.id,paymentId:d.id}),i){case"payment.paid":await c(d);break;case"payment.failed":await u(d);break;case"payment.refunded":await p(d);break;default:console.log(`Unhandled webhook event type: ${i}`)}return o.NextResponse.json({received:!0})}catch(e){return console.error("PayMongo webhook handler error:",e),o.NextResponse.json({error:"Webhook processing failed",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}async function c(e){try{if(!s.db)throw Error("Database connection not available");let t=s.db,r=e.id,a=e.attributes.payment_intent_id,o=e.attributes.amount,n=e.attributes.metadata||{};console.log("Processing successful payment:",{paymentId:r,paymentIntentId:a,amount:o,orderId:n.order_id}),n.order_id&&"string"==typeof n.order_id&&(await t.collection("orders").doc(n.order_id).update({payment_status:"paid",payment_id:r,payment_intent_id:a,paid_amount:o/100,paid_at:new Date,updated_at:new Date}),console.log(`Order ${n.order_id} marked as paid`)),await t.collection("payments").doc(r).set({payment_id:r,payment_intent_id:a,order_id:n.order_id,customer_id:n.customer_id,amount:o/100,currency:e.attributes.currency,status:"paid",payment_method:e.attributes.source?.type||"unknown",metadata:n,created_at:new Date(1e3*e.attributes.created_at),paid_at:new Date(1e3*e.attributes.paid_at),updated_at:new Date}),console.log(`Payment record ${r} stored successfully`)}catch(e){throw console.error("Error handling payment.paid event:",e),e}}async function u(e){try{if(!s.db)throw Error("Database connection not available");let t=s.db,r=e.id,a=e.attributes.payment_intent_id,o=e.attributes.metadata||{};console.log("Processing failed payment:",{paymentId:r,paymentIntentId:a,orderId:o.order_id}),o.order_id&&"string"==typeof o.order_id&&(await t.collection("orders").doc(o.order_id).update({payment_status:"failed",payment_id:r,payment_intent_id:a,payment_error:e.attributes.last_payment_error,updated_at:new Date}),console.log(`Order ${o.order_id} marked as payment failed`)),await t.collection("payments").doc(r).set({payment_id:r,payment_intent_id:a,order_id:o.order_id,customer_id:o.customer_id,amount:e.attributes.amount/100,currency:e.attributes.currency,status:"failed",payment_method:e.attributes.source?.type||"unknown",error:e.attributes.last_payment_error,metadata:o,created_at:new Date(1e3*e.attributes.created_at),updated_at:new Date}),console.log(`Failed payment record ${r} stored successfully`)}catch(e){throw console.error("Error handling payment.failed event:",e),e}}async function p(e){try{if(!s.db)throw Error("Database connection not available");let t=s.db,r=e.id,a=e.attributes.refunds?.[0]?.amount||0,o=e.attributes.metadata||{};console.log("Processing refunded payment:",{paymentId:r,refundAmount:a,orderId:o.order_id}),o.order_id&&"string"==typeof o.order_id&&(await t.collection("orders").doc(o.order_id).update({payment_status:"refunded",refund_amount:a/100,refunded_at:new Date,updated_at:new Date}),console.log(`Order ${o.order_id} marked as refunded`)),await t.collection("payments").doc(r).update({status:"refunded",refund_amount:a/100,refunded_at:new Date,updated_at:new Date}),console.log(`Payment record ${r} updated with refund information`)}catch(e){throw console.error("Error handling payment.refunded event:",e),e}}async function l(){return o.NextResponse.json({error:"Method not allowed"},{status:405})}async function m(){return o.NextResponse.json({error:"Method not allowed"},{status:405})}async function y(){return o.NextResponse.json({error:"Method not allowed"},{status:405})}s=(i.then?(await i)():i)[0],a()}catch(e){a(e)}})},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{"use strict";e.exports=require("path")},38561:(e,t,r)=>{"use strict";r.d(t,{w:()=>s});var a=r(55511),o=r.n(a),n=r(38985);class s{static async createPaymentIntent(e){try{if(!(0,n.hx)(e.amount))throw Error(`Payment amount must be between ₱20.00 and ₱999,999.99. Received: ₱${e.amount}`);let t={data:{attributes:{amount:(0,n.Zd)(e.amount),currency:e.currency||"PHP",description:e.description,statement_descriptor:e.statement_descriptor||"Tap2Go Food Delivery",payment_method_allowed:e.payment_method_allowed||(0,n.lx)(),payment_method_options:e.payment_method_options||{card:{request_three_d_secure:"automatic"}},metadata:{...e.metadata,platform:"tap2go",created_via:"api"}}}};return(await n.Ub.post("/payment_intents",t)).data}catch(e){throw console.error("PayMongo createPaymentIntent error:",e),Error((0,n.TF)(e))}}static async getPaymentIntent(e,t){try{let r=t?`/payment_intents/${e}?client_key=${t}`:`/payment_intents/${e}`,a=t?n.T7:n.Ub;return(await a.get(r)).data}catch(e){throw console.error("PayMongo getPaymentIntent error:",e),Error((0,n.TF)(e))}}static async createPaymentMethod(e){try{let t={data:{attributes:{type:e.type,details:e.details,billing:e.billing,metadata:{...e.metadata,platform:"tap2go"}}}};return(await n.T7.post("/payment_methods",t)).data}catch(e){throw console.error("PayMongo createPaymentMethod error:",e),Error((0,n.TF)(e))}}static async attachPaymentMethod(e){try{let t={data:{attributes:{payment_method:e.payment_method_id,client_key:e.client_key,return_url:e.return_url||`${process.env.NEXT_PUBLIC_APP_URL||"http://localhost:3000"}/payment/callback`}}};return(await n.T7.post(`/payment_intents/${e.payment_intent_id}/attach`,t)).data}catch(e){throw console.error("PayMongo attachPaymentMethod error:",e),Error((0,n.TF)(e))}}static async getPayment(e){try{return(await n.Ub.get(`/payments/${e}`)).data}catch(e){throw console.error("PayMongo getPayment error:",e),Error((0,n.TF)(e))}}static async listPayments(e){try{let t=new URLSearchParams;e?.before&&t.append("before",e.before),e?.after&&t.append("after",e.after),e?.limit&&t.append("limit",e.limit.toString());let r=`/payments${t.toString()?`?${t.toString()}`:""}`;return(await n.Ub.get(r)).data}catch(e){throw console.error("PayMongo listPayments error:",e),Error((0,n.TF)(e))}}static async createRefund(e,t,r){try{let a={data:{attributes:{payment_id:e,amount:t?(0,n.Zd)(t):void 0,reason:r||"requested_by_customer",metadata:{platform:"tap2go",refund_via:"api"}}}};return(await n.Ub.post("/refunds",a)).data}catch(e){throw console.error("PayMongo createRefund error:",e),Error((0,n.TF)(e))}}static verifyWebhookSignature(e,t,r){try{let a=o().createHmac("sha256",r).update(e).digest("hex");return o().timingSafeEqual(Buffer.from(t),Buffer.from(a))}catch(e){return console.error("PayMongo webhook signature verification error:",e),!1}}static getSupportedPaymentMethods(){return(0,n.lx)()}static validateAmount(e){return(0,n.hx)(e)}static convertToCentavos(e){return(0,n.Zd)(e)}static convertFromCentavos(e){return(0,n.Mk)(e)}}},38985:(e,t,r)=>{"use strict";r.d(t,{Mk:()=>p,T7:()=>i,TF:()=>c,Ub:()=>d,Zd:()=>u,hx:()=>l,lx:()=>m});var a=r(94612);let o=process.env.PAYMONGO_PUBLIC_KEY_LIVE,n=process.env.PAYMONGO_SECRET_KEY_LIVE,s=(e=!1)=>{let t=e?n:o;if(!t)throw Error(`PayMongo ${e?"secret":"public"} key is not configured. Please check your environment variables.`);let r=Buffer.from(`${t}:`).toString("base64");return a.A.create({baseURL:"https://api.paymongo.com/v1",headers:{Authorization:`Basic ${r}`,"Content-Type":"application/json",Accept:"application/json"},timeout:3e4})},i=s(!1),d=s(!0),c=e=>e.response?.data?.errors?e.response.data.errors.map(e=>e.detail).join(", "):e.message?e.message:"An unexpected error occurred with the payment gateway.",u=e=>Math.round(100*e),p=e=>e/100,l=e=>e>=20&&e<=999999.99,m=()=>["card","gcash","grab_pay","paymaya","billease","dob"]},44427:(e,t,r)=>{"use strict";r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{patchFetch:()=>c,routeModule:()=>u,serverHooks:()=>m,workAsyncStorage:()=>p,workUnitAsyncStorage:()=>l});var o=r(96559),n=r(48088),s=r(37719),i=r(26671),d=e([i]);i=(d.then?(await d)():d)[0];let u=new o.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/webhooks/paymongo/route",pathname:"/api/webhooks/paymongo",filename:"route",bundlePath:"app/api/webhooks/paymongo/route"},resolvedPagePath:"C:\\Users\\ACER\\Desktop\\tap2go\\apps\\web\\src\\app\\api\\webhooks\\paymongo\\route.ts",nextConfigOutput:"",userland:i}),{workAsyncStorage:p,workUnitAsyncStorage:l,serverHooks:m}=u;function c(){return(0,s.patchFetch)({workAsyncStorage:p,workUnitAsyncStorage:l})}a()}catch(e){a(e)}})},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},83997:e=>{"use strict";e.exports=require("tty")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[4447,580,5195,4612],()=>r(44427));module.exports=a})();